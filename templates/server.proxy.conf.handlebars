{{#if has_members}}
upstream {{ name }}_cluster {
  {{#each members}}
  server {{ host }}:3000;
  {{/each}}
}
{{/if}}

{{#each servers}}
server {
  {{#each listen}}
  listen {{to}}{{#each options}} {{key}}{{#if value}}={{value}}{{/if}}{{/each}};
  {{/each}}
  server_name {{ domain }};

  {{#each options}}
  {{key}}{{#if value}}={{value}}{{/if}}
  {{/each}}

  {{#if redirect_to_http}}
  return 302 http://$server_name$request_uri;
  {{else if redirect_to_https}}
  return 302 https://$server_name$request_uri;
  {{else}}
  root /var/www/{{ name }};

  location / {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header Host $http_host;
    proxy_redirect off;

    # Serve cached index if it exists.
    if (-f $request_filename/index.html) {
      rewrite (.*) $1/index.html break;
    }

    # Serve cached page if it exists.
    if (-f $request_filename.html) {
      rewrite (.*) $1.html break;
    }

    {{#if has_members}}
    # Pass request to app.
    if (!-f $request_filename) {
      proxy_pass http://{{ name }}_cluster;
      break;
    }
    {{else}}
    return 502;
    {{/if}}
  {{/if}}
}
{{/each}}
